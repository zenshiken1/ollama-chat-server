<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AI ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f1f3f5; margin:0; padding:20px;}
    #chat  { max-width:680px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.1);}
    #messages { height:420px; overflow-y:auto; border:1px solid #ddd; padding:12px; margin-bottom:10px;}
    .msg { margin:8px 0; line-height:1.4; }
    .user { color:#0b5cff; font-weight:bold; }
    .bot  { color:#22863a; }
    #inputBar { display:flex; gap:8px; }
    input[type=text]{ flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;}
    button{ padding:8px 16px; border:none; background:#0b5cff; color:white; border-radius:6px; cursor:pointer; }
    button:disabled{ background:#888; }
    #modelBar { margin-bottom:10px; }
    select{ padding:6px; border-radius:6px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>ğŸ§  AI ãƒãƒ£ãƒƒãƒˆ</h2>
    <div id="modelBar">
      <label for="modelSelect">ãƒ¢ãƒ‡ãƒ«é¸æŠ:</label>
      <select id="modelSelect"></select>
    </div>
    <div id="messages"></div>

    <div id="inputBar">
      <input id="input" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆEnterã‚­ãƒ¼ã§é€ä¿¡ï¼‰"/>
      <button id="sendBtn">é€ä¿¡</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket   = io();
    const input    = document.getElementById('input');
    const sendBtn  = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const modelSelect = document.getElementById('modelSelect');
    let currentBotDiv = null;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function append(text, cls){
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§å–å¾—å¾Œã€ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
    socket.on('modelList', (models) => {
      models.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        modelSelect.appendChild(opt);
      });
    });

    // ãƒ¢ãƒ‡ãƒ«é¸æŠå¤‰æ›´æ™‚ã‚¤ãƒ™ãƒ³ãƒˆ
    modelSelect.addEventListener('change', () => {
      socket.emit('selectModel', modelSelect.value);
    });

    // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
    function send(){
      const text = input.value.trim();
      if(!text) return;
      append('ã‚ãªãŸ: ' + text, 'user');
      socket.emit('userMessage', text);
      input.value = '';
      input.focus();
    }

    // ã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹
    socket.on('botStart', () => {
      currentBotDiv = append('AI: ', 'bot');
    });

    // ã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡
    socket.on('botStream', chunk => {
      if(currentBotDiv){
        currentBotDiv.textContent += chunk;
        messages.scrollTop = messages.scrollHeight;
      }
    });

    // ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†
    socket.on('botDone', () => {
      currentBotDiv = null;
    });

    // Enterã‚­ãƒ¼é€ä¿¡
    input.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });
    sendBtn.addEventListener('click', send);
  </script>
</body>
</html>
